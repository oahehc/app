<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<!--Load jquery-->
	<script type="text/javascript" src="js/jquery-2.1.4.min.js"></script> 
	<!--Load jquery mobile-->	
	<link rel="stylesheet" href="js/jquery.mobile-1.4.5.css">
	<script src="js/jquery.mobile-1.4.5.js"></script>
	<!--Load CSS-->
	<link href="css/decision.css" media="screen" rel="stylesheet" type="text/css">	
	<title>Decision</title>
</head>
	<script language="JavaScript">
		var constants = {
			'title_add': 'decision_',
			'selection_separate': '!!',
			'max_width': 5,
			'num_last_record': 5
		};
	
	
		$(function(){
		//close dialog msg for custom alert
			$("input.close").click(function(){	
				$(".ui-dialog").dialog("close");
			})
			
		//purge localStorage
			$("input#purge_data").click(function(){
				localStorage.clear();
				window.location.reload();
			})	

		//start draw
			$("input#start_draw").click(function(){
				//set parameter
				var option = $(this).data('num');
				var tag = -1;
				var now = Date.now();

				//ramdom click time
				var total_click = Math.round(Math.random()*option) + option*5 + (now % option);		
				
				//clear all selected
				$("div#selected").removeAttr("id");

				//start drawing
				drawing(tag,option,total_click);
			})
				function drawing(tag,option,total_click){
					if(total_click>0)
					{
					//remove old selected option
					var start_class = "div.option_" + (tag % option);
					$(start_class).removeAttr("id");
					//selected new option
					var new_class = "div.option_" + ((tag+1) % option);
					$(new_class).attr("id", "selected");

					//decrease delay time
					if(total_click == 1)
					{var delay_time = 10;}
					else
					{var delay_time = 1000/total_click;}
					
					tag++;
					total_click--;
					setTimeout(function(){drawing(tag,option,total_click);},delay_time);
					}
					else
					{
					//highlight final option
					var start_class = "div.option_" + (tag % option);
					$(start_class).removeAttr("id");
					$(start_class).attr("id", "finish");
					}
				}	

		//create list
			
		});	
		
		
		//custom alert msg
			function alert_dialog(msg){
				//show dialog
				$("#open_dialog").click();
				
				//show button for confirm
				$("div#confirm_button").addClass('hide');
				$("div#alert_button").removeClass();
				
				//set message to dialog
				$("h1.msg").empty();	
				$("h1.msg").append(msg);
			}		
	
		
		//create draw content when draw title been updated
			function create_draw_content(title){
				//select localstorage
				var selection = localStorage.getItem(title);
				var array_selection = selection.split(constants.selection_separate);//selection separate character
				
				//set selection number
				var selection_num = array_selection.length;
				$("input#start_draw").data('num',selection_num); 
				
				//create selection
					//selection width adjust
					var width = "w" + Math.min(Math.ceil(array_selection.length/10), constants.max_width);
				var selection_content = "";
				for(var i=0;i<selection_num;i++)
				{		
				selection_content = selection_content + "<div class='selection " + width + " option_" +i+ "'>" + array_selection[i] + "</div>";
				}
				$("div#selection_content").empty();
				$("div#selection_content").append(selection_content);
			}

		//function to filter localstorage
			function select_localstorage(filter){
				if(localStorage.length != 0)
				{
				var array_result = new Array;
					for(var i=0; i<localStorage.length; i++)
					{					
						check = localStorage.key(i).str.indexOf(filter);
						if(check === null)
						{array_result.push(localStorage.key(i));}					
					}

				return array_result;
				}
				else
				{
				return false;
				}
			}
		
	</script>
<body>
<form name="decision" method="post" data-ajax="false" id="decision_form">
	<a href="#dialog_msg" id="open_dialog" style="display:none;"></a><!--hyperlink for open dialog msg-->	
	<!--
	<input type="hidden" name="draw_title">
	<input type="hidden" name="action">
	<input type="hidden" name="title_code">
	<input type="hidden" name="selection_title">
	<input type="hidden" name="selection_content">
	<input type="hidden" name="reserve">
	-->

	
<!--Create-->
<div data-role="page" id="CREATE" data-theme="b">
	<div data-role="header" data-position="fixed">
		<h1>Create Your Selection</h1>
		<div data-role="navbar" data-iconpos="left">
			<ul>
				<li><a href="#CREATE" data-icon="plus" class="ui-btn-active ui-state-persist">CREATE</a></li>
				<li><a href="#LIST" data-icon="bars">LIST</a></li>
				<li><a href="#DRAW" data-icon="grid">DRAW</a></li>
				<li><a href="#SET" data-icon="gear">SET</a></li>
			</ul>
		</div>
	</div>
	<div data-role="content">
		<input id="input_title" type="text" name="title" placeholder="Title" maxlength=20 autofocus>
		<textarea name="selection" placeholder="Selection 1&#10;Selection 2&#10;Selection 3&#10;..."></textarea>
		<div data-role="controlgroup" data-type="horizontal">
			<input type="button" value="Create" onclick="create_selection()">
			<input type="button" value="Reset" onclick="form_reset()">
		</div>
	</div>
	<div data-role="footer" data-position="fixed">
		<h1>Oahehc@2015</h1>
	</div>
</div>


<!--LIST-->
<div data-role="page" id="LIST" data-theme="b">
	<div data-role="header" data-position="fixed">
		<h1>Select a Group to Draw</h1>
		<div data-role="navbar" data-iconpos="left">
			<ul>
				<li><a href="#CREATE" data-icon="plus">CREATE</a></li>
				<li><a href="#LIST" data-icon="bars" class="ui-btn-active ui-state-persist">LIST</a></li>
				<li><a href="#DRAW" data-icon="grid">DRAW</a></li>
				<li><a href="#SET" data-icon="gear">SET</a></li>
			</ul>
		</div>
	</div>
	
	<div data-role="content">
		<div id="list_last">
			<h2>Recent</h2>
		</div>
		
		<div id="favor_last">
			<h2>★ My Favor</h2>
		</div>
	
<!--
		//select and show last x records
		echo "<h2>Recent</h2>";
		$select_last_title = "select distinct code,title from decision where reserve!='Y' and code in $string_title group by code order by create_date desc";
		$result_last_title = mysql_query($select_last_title);
		$num_last_title = mysql_num_rows($result_last_title);
		
			for($i=0;$i<$num_last_title;$i++)
			{
			$data_last_title = mysql_fetch_row($result_last_title);
			
			$select_selections = "select selection_content from decision where code='".$data_last_title[0]."' order by selection_content";
			$result_selections = mysql_query($select_selections);
			$num_selections = mysql_num_rows($result_selections);	

			//load default open for editing list
			if($_SESSION["session_openlist"] == $data_last_title[0])
			{$collapsed_setting = "false";}
			else
			{$collapsed_setting = "true";}
			
			echo "<div data-role='collapsible' data-collapsed='$collapsed_setting'>";
			echo "<h4>".$data_last_title[1]."<span class='ui-li-count'>".$num_selections."</span></h4>";
				echo "<ul data-role='listview'>";
				//function line
				echo "<li data-icon='grid' data-theme='a' class='function'>";
					echo "<div class='function ui-btn ui-icon-grid ui-btn-icon-left' onclick=\"start_draw('".$data_last_title[0]."')\">Draw</div>";
					echo "<div class='function ui-btn ui-icon-star ui-btn-icon-left' onclick=\"add_myfavor('".$data_last_title[0]."')\">Favor</div>";
					echo "<div class='function ui-btn ui-icon-edit ui-btn-icon-left'><a href='#dialog_".$data_last_title[0]."' data-rel='dialog' class='fill'>Edit</a></div>";
					echo "<div class='function ui-btn ui-icon-delete ui-btn-icon-left' onclick=\"delete_group('".$data_last_title[0]."','".$data_last_title[1]."')\">Delete</div>";			
				echo "</li>";
				
				for($j=0;$j<$num_selections;$j++)
				{
				$data_selections = mysql_fetch_row($result_selections);
				echo "<li data-icon='delete'>";
					echo "<a href='#'>";
					echo $data_selections[0];
					echo "</a>";
					echo "<a href='#' onclick=\"delete_selection('".$data_last_title[0]."','".$data_selections[0]."')\"></a>";
//echo "<a href='#' class='delete_function delete_".$data_last_title[0]."' onclick=\"delete_selection('".$data_last_title[0]."','".$data_selections[0]."')\"></a>";
//echo "<a href='#' id='delete_".$data_last_title[0]."'></a>";
				echo "</li>";
				}
				
				//list for new selection create
				echo "<li data-icon='plus'>";
					echo "<a class='unpadding' href='#'>";
					echo "<input class='small new_selection_$data_last_title[0]'>";
					echo "</a>";	
					echo "<a href='#' onclick=\"add_selection('".$data_last_title[0]."','".$data_last_title[1]."','N')\">";	
					echo "</a>";						
				echo "</li>";						
				
				echo "</ul>";
			echo "</div>";
			}
			
		//select and show reserve records		
		echo "<h2>★ My Favor</h2>";
		$select_favor_title = "select distinct code,title from decision where reserve='Y' and code in $string_title group by code order by create_date desc";
		$result_favor_title = mysql_query($select_favor_title);
		$num_favor_title = mysql_num_rows($result_favor_title);
		
			for($i=0;$i<$num_favor_title;$i++)
			{
			$data_favor_title = mysql_fetch_row($result_favor_title);
			
			$select_selections = "select selection_content from decision where code='".$data_favor_title[0]."' order by selection_content";
			$result_selections = mysql_query($select_selections);
			$num_selections = mysql_num_rows($result_selections);			
			
			//load default open for editing list
			if($_SESSION["session_openlist"] == $data_favor_title[0])			
			{$collapsed_setting = "false";}
			else
			{$collapsed_setting = "true";}
			
			echo "<div data-role='collapsible' data-collapsed='$collapsed_setting'>";
			echo "<h4>".$data_favor_title[1]."<span class='ui-li-count'>".$num_selections."</span></h4>";
				echo "<ul data-role='listview'>";
				//function line
				echo "<li data-icon='grid' data-theme='a' class='function'>";
					echo "<div class='function ui-btn ui-icon-grid ui-btn-icon-left' onclick=\"start_draw('".$data_favor_title[0]."')\">Draw</div>";
					echo "<div class='function ui-btn ui-icon-star ui-btn-icon-left' onclick=\"remove_myfavor('".$data_favor_title[0]."')\">Favor</div>";
					echo "<div class='function ui-btn ui-icon-edit ui-btn-icon-left'><a href='#dialog_".$data_favor_title[0]."' data-rel='dialog' class='fill'>Edit</a></div>";
					echo "<div class='function ui-btn ui-icon-delete ui-btn-icon-left' onclick=\"delete_group('".$data_favor_title[0]."')\">Delete</div>";			
				echo "</li>";
				
				for($j=0;$j<$num_selections;$j++)
				{
				$data_selections = mysql_fetch_row($result_selections);
				echo "<li data-icon='delete'>";
					echo "<a href='#'>";
					echo $data_selections[0];
					echo "</a>";
					echo "<a href='#' onclick=\"delete_selection('".$data_favor_title[0]."','".$data_selections[0]."')\">";
					echo "</a>";
				echo "</li>";
				}
				
				//list for new selection create
				echo "<li data-icon='plus'>";
					echo "<a class='unpadding' href='#'>";
					echo "<input class='small new_selection_$data_favor_title[0]'>";
					echo "</a>";	
					echo "<a href='#' onclick=\"add_selection('".$data_favor_title[0]."','".$data_favor_title[1]."','Y')\">";	
					echo "</a>";			
				echo "</li>";	
				
				echo "</ul>";
			echo "</div>";
			}
-->
	</div>
	
	<div data-role="footer" data-position="fixed">
		<h1>Oahehc@2015</h1>
	</div>
</div>
	<!--dialog for title rename-->
<!--
	$select_all_title = "select distinct code,title from decision group by code order by create_date desc";
	$result_all_title = mysql_query($select_all_title);
	$num_all_title = mysql_num_rows($result_all_title);	
	
	for($i=0;$i<$num_all_title;$i++)
	{
	$data_all_title = mysql_fetch_row($result_all_title);
	
	echo "<div data-role='dialog' id='dialog_".$data_all_title[0]."' data-theme='b' data-close-btn='right'>";
		echo "<div data-role='header' data-position='fixed'>";
			echo "<h1>Input New Title</h1>";
		echo "</div>";
		echo "<div data-role='content'>";
			echo "<input type='text' class='new_title_".$data_all_title[0]."' value='".$data_all_title[1]."' autofocus>";
			echo "<input type='button' value='Change Name' onclick=\"rename_title('".$data_all_title[0]."')\">";
		echo "</div>";
	echo "</div>";
	}
-->


<!--Draw-->
<div data-role="page" id="DRAW" data-theme="b">
	<div data-role="header" data-position="fixed">
		<h1>Click to Draw</h1>
		<div data-role="navbar" data-iconpos="left">
			<ul>
				<li><a href="#CREATE" data-icon="plus">CREATE</a></li>
				<li><a href="#LIST" data-icon="bars">LIST</a></li>
				<li><a href="#DRAW" data-icon="grid" class="ui-btn-active ui-state-persist">DRAW</a></li>
				<li><a href="#SET" data-icon="gear">SET</a></li>
			</ul>
		</div>
	</div>
	
	<div data-role="content" id="draw_content">
		<input type="button" value="Start" id="start_draw" data-num="">
		<div id="selection_content">
		</div>
	</div>
	
	<div data-role="footer" data-position="fixed">
		<h1>Oahehc@2015</h1>
	</div>
</div>


<!--SET-->
<div data-role="page" id="SET" data-theme="b">
	<div data-role="header" data-position="fixed">
		<h1>Setting</h1>
		<div data-role="navbar" data-iconpos="left">
			<ul>
				<li><a href="#CREATE" data-icon="plus">CREATE</a></li>
				<li><a href="#LIST" data-icon="bars">LIST</a></li>
				<li><a href="#DRAW" data-icon="grid">DRAW</a></li>
				<li><a href="#SET" data-icon="gear" class="ui-btn-active ui-state-persist">SET</a></li>
			</ul>
		</div>
	</div>
	
	<div data-role="content">
		<input type="button" value="Purge Data" id="purge_data">
	</div>

	<div data-role="footer" data-position="fixed">
		<h1>Oahehc@2015</h1>
	</div>
</div>


<!--dialog for alert and confirm msg-->
<div data-role="dialog" id="dialog_msg" data-theme="b" data-close-btn="right">
	<div data-role="header" data-position="fixed">
		<h1 class="msg"></h1>
	</div>
	<div data-role="content">
		<div data-role="navbar" class="hide" id="confirm_button">
			<ul>
				<li><input type="submit" value="Yes" id="confirm"></li>
				<li><input type="button" value="No" class="cancel"></li>
			</ul>
		</div>
		<div data-role="navbar" class="hide" id="alert_button">
			<ul class="hide" id="alert_button">
				<li><input type="button" value="Yes" class="close"></li>
			</ul>
		</div>
	</div>
</div>


</form>
<script type="text/javascript" src="js/index.js"></script>
<script type="text/javascript">
	app.initialize();
</script>
</body>
</html>
<script>
/*create page*/
	function form_reset(){
		document.decision.title.value = "";		
		document.decision.selection.value = "";		
		document.decision.title.focus();
	}
	function create_selection(){
		var title = constants.title_add + document.decision.title.value.trim();
		var selection = document.decision.selection.value.trim();
		var title_check = string_check(title);
		var selection_check = string_check(selection);
		var title_duplicate = localStorage.getItem(title);
		if(title == "")
		{
		document.decision.title.focus();
		alert_dialog("[ERROR]\nPlease input a title");
		}
		else if(title_check != "")
		{
			if((title_check == "") || (title_check == " "))
			{title_check = "space";}
		document.decision.title.select();
		alert_dialog("[ERROR]\nPlease don\'t use " + title_check + " for title");
		}
		else if(selection == "")
		{
		document.decision.selection.focus();
		alert_dialog("[ERROR]\nPlease input selection");
		}
		else if(selection_check != "")
		{
			if((selection_check == "") || (selection_check == " "))
			{selection_check = "space";}
		document.decision.selection.select();
		alert_dialog("[ERROR]\nPlease don\'t use " + selection_check + " for selection");
		}
		else if(title_duplicate != null && title_duplicate !== undefined)
		{
		document.decision.selection.select();
		alert_dialog("[ERROR]\nTitle has been used,\nplease choose another name.");
		}
		else
		{
		/*selection format adjust*/
		var array_selection = selection.split("\n");
		var new_selection = cleanArray(array_selection).join(constants.selection_separate);//selection separate character

		/*set to localstorage*/
		localStorage[title] = new_selection;
		
		/*clear input*/
		document.decision.title.value = "";
		document.decision.selection.value = "";
		
		/*change to draw page*/
		location.replace('decision.html#DRAW');
		create_draw_content(title);
		}
	}
		/*special character check*/
		function string_check(x){
			var array_result = new Array;
			var check = new String;
			var result = new String;
			for(var i=0;i<x.length;i++)
			{
				check = x[i].match('[0-9|A-Za-z|@$()_|\n-]');
				if(check === null)
				{
					if((jQuery.inArray(x[i], array_result)) == -1)//remove repeated character
					{array_result.push(x[i]);}
				}
			}
			var result = array_result.join(" ");
			return result;
		}	
		/*remove empty element*/
		function cleanArray(actual) {
		  var newArray = new Array();
		  for (var i = 0; i < actual.length; i++) {
			if (actual[i]) {
			  newArray.push(actual[i]);
			}
		  }
		  return newArray;
		}
		
		
/*list page*/
	

</script>